import os
import sys
import time
import asyncio
import subprocess
from datetime import datetime

# [Step 0] ë¼ì´ë¸ŒëŸ¬ë¦¬ ìë™ ì ê²€ (Self-Healing)
# --------------------------------------------------------------------------------
def check_and_install(package, import_name=None):
    if import_name is None: import_name = package
    try:
        __import__(import_name)
    except ImportError:
        print(f"ğŸ› ï¸ [ì‹œìŠ¤í…œ] í•„ìˆ˜ ë„êµ¬ '{package}' ì„¤ì¹˜ ì¤‘...")
        subprocess.check_call([sys.executable, "-m", "pip", "install", package])

check_and_install("python-dotenv", "dotenv")
check_and_install("langchain-google-genai")
check_and_install("langchain")
check_and_install("langchain-core")

from dotenv import load_dotenv
from langchain_google_genai import ChatGoogleGenerativeAI
from langchain_core.prompts import PromptTemplate

# [Step 1] í™˜ê²½ ì„¤ì •
# --------------------------------------------------------------------------------
load_dotenv()
api_key = os.getenv("GOOGLE_API_KEY")

# [Step 2] ê³ ë„í™”ëœ Mock Data (ë¶„ì„ ì‹œë‚˜ë¦¬ì˜¤)
# --------------------------------------------------------------------------------
# ì‹œë‚˜ë¦¬ì˜¤: ìƒì†ë°›ì€ ê³µì¥ìš©ì§€, ì˜¤ë˜ëœ ì€í–‰ ëŒ€ì¶œ + ìµœê·¼ ëŒ€ë¶€ì—… ëŒ€ì¶œ í˜¼ì¬, ì„ì°¨ê¶Œë“±ê¸° ì„¤ì •ë¨
TARGET_ADDRESS = "ê²½ê¸°ë„ ê¹€í¬ì‹œ í†µì§„ì ë„ì‚¬ë¦¬ 163-1"

MOCK_DOC_INFO = """
[í‘œì œë¶€]
- ìš©ë„: ê³µì¥ìš©ì§€ (ê³„íšê´€ë¦¬ì§€ì—­)
- ê±´ë¬¼: ì œ2ì¢…ê·¼ë¦°ìƒí™œì‹œì„¤(ì œì¡°ì—…ì†Œ)

[ê°‘êµ¬ (ì†Œìœ ê¶Œ)]
- 2019.05.01 ì†Œìœ ê¶Œì´ì „ (ì›ì¸: í˜‘ì˜ë¶„í• ì— ì˜í•œ ìƒì†) / ì†Œìœ ì: ê¹€ì§€ìƒ (ë‹¨ë…ì†Œìœ )
- 2023.06.15 ë‹´ë³´ì‹ íƒë“±ê¸° (ìˆ˜íƒì: ìš°ë¦¬ìì‚°ì‹ íƒ) *íŠ¹ì•½ì‚¬í•­: ì‹ íƒì›ë¶€ ì œ2023-55í˜¸
- 2024.01.10 ê°€ì••ë¥˜ (ì±„ê¶Œì: ê¹€í¬ì„¸ë¬´ì„œ)

[ì„êµ¬ (ì†Œìœ ê¶Œ ì´ì™¸)]
- ìˆœìœ„1: 2020.06.01 ê·¼ì €ë‹¹ê¶Œì„¤ì • / ê¶Œë¦¬ì: êµ­ë¯¼ì€í–‰ / ì±„ê¶Œìµœê³ ì•¡: 5ì–µì› 
  (ê³µë™ë‹´ë³´ëª©ë¡ ì œ2020-101í˜¸) *ì„¤ì • í›„ 4ë…„ ê²½ê³¼*
- ìˆœìœ„2: 2023.12.01 ê·¼ì €ë‹¹ê¶Œì„¤ì • / ê¶Œë¦¬ì: ëŸ¬ì‹œì•¤ìºì‹œëŒ€ë¶€ / ì±„ê¶Œìµœê³ ì•¡: 3ì–µì›
  *2ê¸ˆìœµ/ëŒ€ë¶€ì—…ì²´*
- ìˆœìœ„3: 2024.02.01 ì£¼íƒì„ì°¨ê¶Œë“±ê¸° / ê¶Œë¦¬ì: ì´ì„¸ì… / ë³´ì¦ê¸ˆ: 5,000ë§Œì›
"""

MOCK_MARKET_INFO = """
- í˜„ì¬ ê¸ˆë¦¬ ê¸°ì¡°: ê¸°ì¤€ê¸ˆë¦¬ ì¸í•˜ ì˜ˆìƒ (ëŒ€í™˜ëŒ€ì¶œ ìœ ë¦¬)
- ê·œì œ: í† ì§€ê±°ë˜í—ˆê°€êµ¬ì—­ ì•„ë‹˜
"""

# [Step 3] ì§€ìƒ AI í”„ë¡œ ì—”ì§„ (Gemini 1.5 Flash)
# --------------------------------------------------------------------------------
class JisangProEngine:
    def __init__(self):
        if not api_key:
            print("âŒ [ì˜¤ë¥˜] API Keyê°€ ì—†ìŠµë‹ˆë‹¤.")
            sys.exit(1)
        
        # ê°€ì„±ë¹„ì™€ ì†ë„ê°€ ë›°ì–´ë‚œ Flash ëª¨ë¸ ì‚¬ìš©
        self.llm = ChatGoogleGenerativeAI(
            model="gemini-1.5-flash", 
            temperature=0.0, # ë¶„ì„ì€ ì°½ì˜ì„± 0, ì •í™•ë„ 100
            google_api_key=api_key
        )

    def analyze_advanced(self, address, doc_data, market_data):
        prompt = PromptTemplate.from_template("""
            ë‹¹ì‹ ì€ ìƒìœ„ 0.1% ë¶€ë™ì‚°/ê¸ˆìœµ ì „ë¬¸ê°€ AI 'ì§€ìƒ'ì…ë‹ˆë‹¤.
            ì…ë ¥ëœ ë“±ê¸° ë°ì´í„°ë¥¼ [8ëŒ€ í•µì‹¬ í•­ëª© + 3ëŒ€ ì‹¬í™” ì „ëµ]ì— ë§ì¶° ì •ë°€ ë¶„ì„í•˜ê³ ,
            ê¸ˆìœµ/ì¤‘ê°œ/íˆ¬ì ì „ë¬¸ê°€ë¥¼ ìœ„í•œ 'Actionable Report'ë¥¼ ì‘ì„±í•˜ì„¸ìš”.

            [ë¶„ì„ ëŒ€ìƒ]: {address}
            [ë“±ê¸°/ê³µì ì¥ë¶€]: {doc_data}
            [ì‹œì¥ ìƒí™©]: {market_data}

            ---
            [ë¶„ì„ ì§€ì¹¨]
            1. **ê·¼ì €ë‹¹ ë¶„ì„**: 
               - ì„¤ì •ì¼ ê¸°ì¤€ 24ê°œì›” ê²½ê³¼ ì—¬ë¶€ í™•ì¸ -> ëŒ€í™˜ëŒ€ì¶œ(ê°ˆì•„íƒ€ê¸°) ì¶”ì²œ ëŒ€ìƒì¸ì§€ íŒë³„.
               - ê¶Œë¦¬ì ë¶„ì„ (1ê¸ˆìœµ vs ëŒ€ë¶€ì—…) -> ê³ ê¸ˆë¦¬ ëŒ€ì¶œ ìƒí™˜ ì „ëµ ì œì‹œ.
               - ê³µë™ë‹´ë³´ ì¤‘ë³µ ê³„ì‚° ë°©ì§€ ë¡œì§ ì ìš© ëª…ì‹œ.
            2. **ì†Œìœ ê¶Œ ë¶„ì„**: ìƒì†/ì¦ì—¬ ì—¬ë¶€, ë‹¨ë…/ê³µìœ  ì§€ë¶„ ë¶„ì„.
            3. **ë¦¬ìŠ¤í¬ ì‹ í˜¸ë“±(Traffic Light)**:
               - ğŸ”´ìœ„í—˜: ê²½ë§¤/ê³µë§¤ ê°œì‹œ, ì„ì°¨ê¶Œë“±ê¸°, ì‹ íƒë“±ê¸°(ë¯¸í™•ì¸ ì‹œ), ê°€ë“±ê¸°
               - ğŸŸ¡ì£¼ì˜: 2ê¸ˆìœµê¶Œ ê³¼ë‹¤ ëŒ€ì¶œ, ì„¸ê¸ˆ ì²´ë‚© ì••ë¥˜
               - ğŸŸ¢ì–‘í˜¸: ê¹¨ë—í•œ ë“±ê¸°
            
            ---
            [ì¶œë ¥ ì–‘ì‹ (Markdown)]
            ## ğŸ¢ [ì§€ìƒ AI] ì´ˆê²©ì°¨ ê¶Œë¦¬/ê¸ˆìœµ ë¶„ì„ ë¦¬í¬íŠ¸

            ### 1. ğŸš¦ ê¶Œë¦¬ ë¦¬ìŠ¤í¬ ì‹ í˜¸ë“±: [ğŸ”´/ğŸŸ¡/ğŸŸ¢] (í•µì‹¬ ì‚¬ìœ )
            
            ### 2. ğŸ’° ê¸ˆìœµ/ëŒ€ì¶œ ì„¸ì¼ì¦ˆ í¬ì¸íŠ¸ (Leads)
            - **ëŒ€í™˜ëŒ€ì¶œ ê¸°íšŒ**: [ìœ /ë¬´] (ì´ìœ : ì˜ˆ - êµ­ë¯¼ì€í–‰ ê·¼ì €ë‹¹ 4ë…„ ê²½ê³¼, ê¸ˆë¦¬ ì¸í•˜ í™œìš© ê°€ëŠ¥)
            - **ì‹ ìš©íšŒë³µ ì†”ë£¨ì…˜**: [í•„ìš”/ë¶ˆí•„ìš”] (ì´ìœ : ì˜ˆ - ëŒ€ë¶€ì—…ì²´ ê³ ê¸ˆë¦¬ ì´ìš© ì¤‘)
            - **LTV ì¶”ì •**: (ê³µë™ë‹´ë³´ ê³ ë ¤í•œ ì‹¤ì±„ê¶Œì•¡ ì¶”ì‚°)

            ### 3. âš–ï¸ ìƒì„¸ ê¶Œë¦¬ ë¶„ì„ (Deep Dive)
            - **ì†Œìœ  í˜•íƒœ**: [ê°œì¸/ë²•ì¸] (ìƒì†/ì¦ì—¬ ì—¬ë¶€)
            - **ê°‘êµ¬ ë¦¬ìŠ¤í¬**: (ê°€ì••ë¥˜/ì‹ íƒ ë“±ê¸° ìƒì„¸ í•´ì„¤ ë° ëŒ€ì‘ë²•)
            - **ì„êµ¬ ë¦¬ìŠ¤í¬**: (ì„ì°¨ê¶Œë“±ê¸° ë§ì†Œ ì¡°ê±´ë¶€ ê³„ì•½ í•„ìˆ˜ ë“±)

            ### 4. ğŸ“ ì „ë¬¸ê°€(ì¤‘ê°œ/ê¸ˆìœµ)ë¥¼ ìœ„í•œ í•œ ì¤„ ì œì–¸
            > [ì—¬ê¸°ì— ì „ë¬¸ê°€ê°€ ê³ ê°ì—ê²Œ ë¸Œë¦¬í•‘í•  ë©˜íŠ¸ ì‘ì„±]
        """)
        
        chain = prompt | self.llm
        return chain.invoke({
            "address": address,
            "doc_data": doc_data,
            "market_data": market_data
        }).content

# [Step 4] ì‹¤í–‰ (Orchestration)
# --------------------------------------------------------------------------------
async def main():
    print("\n" + "="*80)
    print("ğŸš€ [ì§€ìƒ AI] ë¶€ë™ì‚° ë”¥í…Œí¬ ì‹œìŠ¤í…œ (Advanced Ver.) ê°€ë™")
    print("   >> ê¸°ëŠ¥: ëŒ€í™˜ëŒ€ì¶œ í¬ì°©, ì‹ íƒ/ì••ë¥˜ ë¦¬ìŠ¤í¬ ë¶„ì„, ê³µë™ë‹´ë³´ í•„í„°ë§")
    print("="*80)

    # íŒŒì´í”„ë¼ì¸ ì‹œë®¬ë ˆì´ì…˜
    print(f"\n[Phase 1] ë°ì´í„° íŒŒì´í”„ë¼ì¸ ê°€ë™... (Target: {TARGET_ADDRESS})")
    time.sleep(0.5)
    print("   >>> ğŸ“„ ë“±ê¸°ì‚¬í•­ì „ë¶€ì¦ëª…ì„œ íŒŒì‹± ì™„ë£Œ (ê°‘êµ¬/ì„êµ¬ ë¶„ë¦¬)")
    print("   >>> ğŸ”¢ ê³µë™ë‹´ë³´ ëª©ë¡ ëŒ€ì¡° ë° ì¤‘ë³µ ì±„ê¶Œì•¡ í•„í„°ë§ ì™„ë£Œ")
    
    # 24ê°œì›” ê²½ê³¼ ì²´í¬ ë¡œì§ ì‹œë®¬ë ˆì´ì…˜
    print("   >>> â³ [Time Check] êµ­ë¯¼ì€í–‰ ê·¼ì €ë‹¹(2020ë…„) -> 24ê°œì›” ê²½ê³¼ í™•ì¸ (ëŒ€í™˜ íƒ€ê²Ÿ)")
    print("   >>> ğŸš¨ [Risk Check] 'ëŸ¬ì‹œì•¤ìºì‹œ(ëŒ€ë¶€)' ë° 'ì„ì°¨ê¶Œë“±ê¸°' ê°ì§€ -> Red Flag")

    print("\n[Phase 2] Gemini 1.5 Flash ì´ˆê³ ì† ì •ë°€ ì¶”ë¡ ")
    engine = JisangProEngine()
    
    start = time.time()
    result = engine.analyze_advanced(TARGET_ADDRESS, MOCK_DOC_INFO, MOCK_MARKET_INFO)
    end = time.time()

    print(f"   >>> âœ… ë¶„ì„ ì™„ë£Œ (Latency: {end - start:.2f}ì´ˆ)")
    print("-" * 80)
    print(result)
    print("-" * 80)
    print("\n[System] ê²°ê³¼ê°€ ê¸ˆìœµ ì˜ì—… ë¦¬ìŠ¤íŠ¸ ë° ì¤‘ê°œì‚¬ CRMì— ìë™ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.")

if __name__ == "__main__":
    if sys.platform == 'win32':
        asyncio.set_event_loop_policy(asyncio.WindowsSelectorEventLoopPolicy())
    asyncio.run(main())